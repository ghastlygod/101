<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建造業證件全自動識別系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .auto-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <div class="max-w-md mx-auto p-4">
        <!-- 標題欄 -->
        <header class="text-center my-6">
            <h1 class="text-2xl font-bold text-slate-800">建造業證件全自動填表</h1>
            <p class="text-slate-500 mt-2 text-sm">拍照後自動 AI 分析並上傳雲端</p>
            <div class="flex justify-center space-x-4 mt-2">
                <button onclick="resetApiKey()" class="text-xs text-red-500 underline">清除/更換 API Key</button>
                <button onclick="checkKeyStatus()" class="text-xs text-blue-500 underline">檢查 Key 狀態</button>
            </div>
        </header>

        <!-- 相機 / 上傳 區塊 -->
        <div class="bg-white rounded-2xl shadow-sm p-5 mb-6 border border-slate-200">
            <div class="flex flex-col items-center justify-center border-2 border-dashed border-slate-300 rounded-xl p-8 bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer relative" id="uploadZone">
                <input type="file" id="cameraInput" accept="image/*" capture="environment" class="absolute inset-0 opacity-0 cursor-pointer">
                <div class="bg-blue-600 p-4 rounded-full mb-3 shadow-lg shadow-blue-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    </svg>
                </div>
                <span class="text-base font-bold text-blue-600">點擊此處拍照</span>
            </div>
            
            <div id="processContainer" class="hidden mt-4 text-center p-4 bg-blue-50 rounded-xl border border-blue-100">
                <div class="flex items-center justify-center space-x-3 mb-2">
                    <div class="loading-spinner" style="width: 24px; height: 24px;"></div>
                    <span id="processStatus" class="font-bold text-blue-700 auto-pulse">正在透過 AI 識別...</span>
                </div>
                <img id="imagePreview" src="" alt="預覽" class="w-full h-32 object-cover rounded-lg mt-2 opacity-50 grayscale">
            </div>
        </div>

        <!-- 結果顯示表單 -->
        <div class="bg-white rounded-2xl shadow-sm p-6 border border-slate-200 mb-10 opacity-60" id="resultCard">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-lg font-bold text-slate-800 border-l-4 border-blue-500 pl-3">資料確認</h2>
                <div id="syncBadge" class="hidden px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded">已同步</div>
            </div>
            
            <form id="infoForm" class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">中文姓名</label>
                        <input type="text" id="chiName" readonly class="w-full bg-slate-50 border-0 rounded-lg p-2 text-slate-800 text-sm">
                    </div>
                    <div class="form-group">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">英文姓名</label>
                        <input type="text" id="engName" readonly class="w-full bg-slate-50 border-0 rounded-lg p-2 text-slate-800 text-sm">
                    </div>
                </div>
                <div class="form-group">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">身分證號碼</label>
                    <input type="text" id="idNumber" readonly class="w-full bg-slate-50 border-0 rounded-lg p-2 text-slate-800 text-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="block text-xs font-bold text-slate-400 mb-1 text-blue-600">平安卡號</label>
                        <input type="text" id="safetyCardNo" readonly class="w-full bg-slate-50 border-0 rounded-lg p-2 text-slate-800 text-sm">
                    </div>
                    <div class="form-group">
                        <label class="block text-xs font-bold text-slate-400 mb-1 text-green-600">註冊證號</label>
                        <input type="text" id="workerRegNo" readonly class="w-full bg-slate-50 border-0 rounded-lg p-2 text-slate-800 text-sm">
                    </div>
                </div>
            </form>
            <button onclick="window.location.reload()" class="w-full mt-6 py-3 border border-slate-200 text-slate-400 rounded-xl text-sm font-medium">完成並掃描下一張</button>
        </div>
    </div>

    <!-- API KEY 彈窗 -->
    <div id="keyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[100] hidden">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-2">設定 API Key</h3>
            <p class="text-sm text-gray-500 mb-4">目前的金鑰無效或尚未設定。請從 Google AI Studio 獲取新金鑰並貼上。</p>
            <input type="password" id="keyInput" class="w-full border rounded-lg p-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="在此貼上金鑰...">
            <button onclick="saveApiKey()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors">儲存並開始</button>
            <p class="text-[10px] text-gray-400 mt-4 text-center">金鑰僅存於瀏覽器 localStorage，不會上傳至伺服器原始碼。</p>
        </div>
    </div>

    <div id="statusToast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full text-sm shadow-2xl transition-all duration-300 opacity-0 pointer-events-none z-50"></div>

    <script>
        // 常數設定
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbzM8jY9AOjZjW9L-bB0TyKsUa7yX3KeIUYAUaDH8ih4sm5v3kjmToVVg3mKsI4OOiIuiA/exec";
        let apiKey = localStorage.getItem('gemini_api_key') || "";

        const cameraInput = document.getElementById('cameraInput');
        const imagePreview = document.getElementById('imagePreview');
        const uploadZone = document.getElementById('uploadZone');
        const processContainer = document.getElementById('processContainer');
        const processStatus = document.getElementById('processStatus');
        const statusToast = document.getElementById('statusToast');
        const resultCard = document.getElementById('resultCard');
        const syncBadge = document.getElementById('syncBadge');
        const keyModal = document.getElementById('keyModal');

        window.onload = () => {
            if (!apiKey) {
                keyModal.classList.remove('hidden');
            }
        };

        function saveApiKey() {
            const val = document.getElementById('keyInput').value.trim();
            if (val) {
                localStorage.setItem('gemini_api_key', val);
                apiKey = val;
                keyModal.classList.add('hidden');
                showToast("✅ 金鑰已更新，請重新嘗試拍照");
            } else {
                showToast("❌ 請輸入有效的金鑰");
            }
        }

        function resetApiKey() {
            localStorage.removeItem('gemini_api_key');
            apiKey = "";
            document.getElementById('keyInput').value = "";
            keyModal.classList.remove('hidden');
            showToast("金鑰已清除");
        }

        function checkKeyStatus() {
            if(!apiKey) showToast("尚未設定金鑰");
            else showToast("已設定金鑰，若無法識別請嘗試更換");
        }

        cameraInput.addEventListener('change', async function(e) {
            if (!apiKey) {
                keyModal.classList.remove('hidden');
                return;
            }
            const file = e.target.files[0];
            if (!file) return;

            uploadZone.classList.add('hidden');
            processContainer.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = async function(event) {
                imagePreview.src = event.target.result;
                const base64Data = event.target.result.split(',')[1];
                await autoProcess(base64Data);
            };
            reader.readAsDataURL(file);
        });

        async function autoProcess(base64Image) {
            updateStatus("AI 正在解析證件...", "blue");
            const prompt = `你是一個專業的香港建造業證件識別助手。請從圖中提取以下資訊：chi_name, eng_name, id_number, safety_card_no, safety_card_expiry, worker_reg_no, worker_reg_expiry, worker_trade。請以 JSON 格式回傳。`;

            try {
                const response = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64Image } }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    }
                );

                const data = await response.json();
                
                // 處理 API 回傳的錯誤
                if (data.error) {
                    if (data.error.message.includes("API key not valid") || data.error.status === "INVALID_ARGUMENT") {
                        throw new Error("API 金鑰無效，請點擊重設");
                    }
                    throw new Error(data.error.message);
                }

                const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!resultText) throw new Error("AI 未能產生結果，請確保照片清晰");
                
                const result = JSON.parse(resultText);
                
                fillForm(result);
                resultCard.classList.remove('opacity-60');
                updateStatus("識別成功，正在同步...", "green");
                await uploadData(result);

            } catch (error) {
                console.error(error);
                updateStatus(`失敗: ${error.message}`, "red");
                showToast(`❌ 錯誤: ${error.message}`);
                
                // 如果是金鑰錯誤，自動彈出設定框
                if (error.message.includes("金鑰無效")) {
                    setTimeout(resetApiKey, 1500);
                }
            }
        }

        async function uploadData(result) {
            try {
                await fetch(googleScriptUrl, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(result)
                });
                updateStatus("✅ 已同步至雲端", "emerald");
                syncBadge.classList.remove('hidden');
            } catch (e) {
                showToast("上傳失敗，請檢查 Google Script URL");
            }
        }

        function fillForm(data) {
            document.getElementById('chiName').value = data.chi_name || "---";
            document.getElementById('engName').value = data.eng_name || "---";
            document.getElementById('idNumber').value = data.id_number || "---";
            document.getElementById('safetyCardNo').value = data.safety_card_no || "---";
            document.getElementById('workerRegNo').value = data.worker_reg_no || "---";
        }

        function updateStatus(msg, color) {
            processStatus.textContent = msg;
            processStatus.className = `font-bold text-${color}-700 auto-pulse`;
        }

        async function fetchWithRetry(url, options, retries = 2) {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, options);
                    // 即使不 ok 也要解析 JSON 看看錯誤原因
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({ error: { message: `HTTP ${res.status}` } }));
                        throw new Error(err.error?.message || "網路錯誤");
                    }
                    return res;
                } catch (e) {
                    lastError = e;
                    if (e.message.includes("key not valid") || e.message.includes("金鑰無效")) throw e;
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
            throw lastError;
        }

        function showToast(msg) {
            statusToast.textContent = msg;
            statusToast.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => statusToast.classList.replace('opacity-100', 'opacity-0'), 4000);
        }
    </script>
</body>
</html>
